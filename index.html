<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>FONDAMENTO v5 - Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        button { min-height: 44px; cursor: pointer; }
        input, textarea, select { font-size: 16px; }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex; align-items: center;
            justify-content: center; z-index: 1000; padding: 20px; overflow-y: auto;
        }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: slideIn 0.3s ease-out; }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .message {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }
        
        .message.me { align-items: flex-end; }
        .message.other { align-items: flex-start; }
        
        .message-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .message.me .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.other .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .radio-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .radio-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 12px;
        }
        
        .notification-badge {
            position: relative;
            display: inline-block;
        }
        
        .notification-badge .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://yixuosrfwrxhttbhqelj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpeHVvc3Jmd3J4aHR0YmhxZWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzE5NzIsImV4cCI6MjA4MzgwNzk3Mn0.S7tzB_hou3cSR0mVZlXgExz5BSwCcoIIyiAQJUgwwFo'
        );

        const isMobile = window.innerWidth <= 768;

        const btn = (variant = 'primary') => ({
            width: '100%', padding: '16px', borderRadius: '15px',
            fontSize: '16px', fontWeight: '600', border: 'none',
            background: variant === 'primary' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' :
                       variant === 'success' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' :
                       variant === 'danger' ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' :
                       'white',
            color: variant === 'outline' ? '#667eea' : 'white',
            border: variant === 'outline' ? '2px solid #667eea' : 'none'
        });

        const card = {
            background: 'rgba(255, 255, 255, 0.95)',
            borderRadius: isMobile ? '20px' : '30px',
            padding: isMobile ? '24px 20px' : '40px',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
        };

        const input = {
            width: '100%', padding: '14px 18px', borderRadius: '12px',
            border: '2px solid #e5e7eb', fontSize: '16px', marginBottom: '16px',
            fontFamily: 'inherit'
        };

        const DEPARTEMENTS = [
            'Marketing',
            'Commerce / Ventes',
            'Finance',
            'R&D / Innovation',
            'Ressources Humaines',
            'Direction',
            'IT / Tech',
            'Op√©rations',
            'Autre'
        ];

        const TYPES_BESOIN = [
            'Introduction / Mise en relation',
            'Conseil / Expertise',
            'Opportunit√© B2B',
            'Recrutement',
            'Partenariat',
            'Autre'
        ];

        const getNiveauContactLabel = (niveau) => {
            switch(niveau) {
                case 'direct': return { emoji: 'üü¢', text: 'Contact direct' };
                case 'niveau_2': return { emoji: 'üü°', text: 'Contact 2√®me niveau' };
                case 'niveau_3': return { emoji: 'üü†', text: 'Contact 3√®me niveau' };
                default: return { emoji: '‚ö™', text: 'Non pr√©cis√©' };
            }
        };

        const getJoursRestants = (dateExpiration) => {
            if (!dateExpiration) return null;
            const now = new Date();
            const expiration = new Date(dateExpiration);
            const diff = expiration - now;
            const jours = Math.ceil(diff / (1000 * 60 * 60 * 24));
            return jours;
        };

        const getBadgeStatut = (dateExpiration, statut) => {
            if (statut === 'cloture') {
                return { emoji: '‚úÖ', text: 'Cl√¥tur√©', color: '#6b7280' };
            }
            
            const jours = getJoursRestants(dateExpiration);
            
            if (jours === null || jours < 0) {
                return { emoji: '‚ùå', text: 'Expir√©', color: '#ef4444' };
            }
            
            if (jours <= 2) {
                return { emoji: 'üü†', text: `Expire dans ${jours}j`, color: '#f59e0b' };
            }
            
            return { emoji: 'üü¢', text: `Actif (${jours}j restants)`, color: '#10b981' };
        };

        function App() {
            const [page, setPage] = useState('home');
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [prenom, setPrenom] = useState('');
            const [nom, setNom] = useState('');
            
            const [besoinText, setBesoinText] = useState('');
            const [entrepriseVisee, setEntrepriseVisee] = useState('');
            const [departement, setDepartement] = useState('');
            const [typeBesoin, setTypeBesoin] = useState('');
            
            const [besoins, setBesoins] = useState([]);
            const [mesBesoins, setMesBesoins] = useState([]);
            const [besoinIdx, setBesoinIdx] = useState(0);
            
            const [editMode, setEditMode] = useState(false);
            const [editData, setEditData] = useState({});
            
            const [propositionsParBesoin, setPropositionsParBesoin] = useState({});
            const [showPropsModal, setShowPropsModal] = useState(false);
            const [selectedBesoinProps, setSelectedBesoinProps] = useState(null);
            
            const [showPropositionModal, setShowPropositionModal] = useState(false);
            const [propositionBesoin, setPropositionBesoin] = useState(null);
            const [niveauContact, setNiveauContact] = useState('');
            const [posteContact, setPosteContact] = useState('');
            const [messageProposition, setMessageProposition] = useState('');
            
            const [matchs, setMatchs] = useState([]);
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [selectedMatchProposition, setSelectedMatchProposition] = useState(null);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const messagesEndRef = useRef(null);
            
            // Compteurs notifications
            const [nbNouvellesPropositions, setNbNouvellesPropositions] = useState(0);
            const [nbMessagesNonLus, setNbMessagesNonLus] = useState(0);

            useEffect(() => {
                checkUser();
            }, []);

            useEffect(() => {
                if (page === 'chat' && selectedMatch) {
                    loadMessages();
                    const interval = setInterval(loadMessages, 3000);
                    return () => clearInterval(interval);
                }
            }, [page, selectedMatch]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            useEffect(() => {
                if (user && page === 'dashboard') {
                    loadNotificationCounts();
                    const interval = setInterval(loadNotificationCounts, 5000);
                    return () => clearInterval(interval);
                }
            }, [user, page]);

            const checkUser = async () => {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session?.user) {
                        setUser(session.user);
                        await loadProfile(session.user.id);
                    }
                } catch (err) {
                    console.error('Erreur:', err);
                } finally {
                    setLoading(false);
                }
            };

            const loadProfile = async (userId) => {
                try {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .single();
                    
                    if (error) throw error;
                    setProfile(data);
                } catch (err) {
                    console.error('Erreur profil:', err);
                }
            };

            const loadNotificationCounts = async () => {
                if (!user) return;
                
                try {
                    // Compter nouvelles propositions
                    const { data: mesBesoinsData } = await supabaseClient
                        .from('besoins')
                        .select('id')
                        .eq('user_id', user.id)
                        .eq('statut', 'actif');
                    
                    if (mesBesoinsData && mesBesoinsData.length > 0) {
                        const besoinIds = mesBesoinsData.map(b => b.id);
                        const { count: propsCount } = await supabaseClient
                            .from('propositions')
                            .select('*', { count: 'exact', head: true })
                            .in('besoin_id', besoinIds)
                            .eq('statut', 'en_attente');
                        
                        setNbNouvellesPropositions(propsCount || 0);
                    } else {
                        setNbNouvellesPropositions(0);
                    }
                    
                    // Compter messages non lus
                    const { data: mesMatchsData } = await supabaseClient
                        .from('matchs')
                        .select('id')
                        .or(`demandeur_id.eq.${user.id},aidant_id.eq.${user.id}`);
                    
                    if (mesMatchsData && mesMatchsData.length > 0) {
                        const matchIds = mesMatchsData.map(m => m.id);
                        const { count: msgCount } = await supabaseClient
                            .from('messages')
                            .select('*', { count: 'exact', head: true })
                            .in('match_id', matchIds)
                            .neq('sender_id', user.id)
                            .eq('lu', false);
                        
                        setNbMessagesNonLus(msgCount || 0);
                    } else {
                        setNbMessagesNonLus(0);
                    }
                } catch (err) {
                    console.error('Erreur compteurs:', err);
                }
            };

            const loadMesBesoins = async () => {
                try {
                    const { data, error } = await supabaseClient
                        .from('besoins')
                        .select('*')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    setMesBesoins(data || []);
                    
                    for (const besoin of (data || [])) {
                        await loadPropositionsPourBesoin(besoin.id);
                    }
                } catch (err) {
                    console.error('Erreur mes besoins:', err);
                }
            };

            const loadPropositionsPourBesoin = async (besoinId) => {
                try {
                    const { data, error } = await supabaseClient
                        .from('propositions')
                        .select(`
                            *,
                            profiles:aidant_id (prenom, nom, note_globale, secteur)
                        `)
                        .eq('besoin_id', besoinId);
                    
                    if (error) throw error;
                    setPropositionsParBesoin(prev => ({
                        ...prev,
                        [besoinId]: data || []
                    }));
                } catch (err) {
                    console.error('Erreur props:', err);
                }
            };

            const loadBesoins = async () => {
                try {
                    const { data, error } = await supabaseClient
                        .from('besoins')
                        .select(`
                            *,
                            profiles:user_id (prenom, nom, note_globale, secteur)
                        `)
                        .eq('statut', 'actif')
                        .neq('user_id', user.id)
                        .gt('date_expiration', new Date().toISOString())
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    setBesoins(data || []);
                } catch (err) {
                    console.error('Erreur besoins:', err);
                }
            };

            const loadMatchs = async () => {
                try {
                    const { data, error } = await supabaseClient
                        .from('matchs')
                        .select(`
                            *,
                            besoin:besoin_id (texte, entreprise_visee),
                            demandeur:demandeur_id (prenom, nom, note_globale, secteur),
                            aidant:aidant_id (prenom, nom, note_globale, secteur)
                        `)
                        .or(`demandeur_id.eq.${user.id},aidant_id.eq.${user.id}`)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    setMatchs(data || []);
                } catch (err) {
                    console.error('Erreur matchs:', err);
                }
            };

            const loadMessages = async () => {
                if (!selectedMatch) return;
                
                try {
                    const { data, error } = await supabaseClient
                        .from('messages')
                        .select('*')
                        .eq('match_id', selectedMatch.id)
                        .order('created_at', { ascending: true });
                    
                    if (error) throw error;
                    setMessages(data || []);
                    
                    // Marquer comme lus les messages re√ßus
                    await supabaseClient
                        .from('messages')
                        .update({ lu: true })
                        .eq('match_id', selectedMatch.id)
                        .neq('sender_id', user.id)
                        .eq('lu', false);
                    
                    loadNotificationCounts();
                } catch (err) {
                    console.error('Erreur messages:', err);
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    const { error: signupError } = await supabaseClient.auth.signUp({
                        email, password,
                        options: { data: { prenom, nom } }
                    });

                    if (signupError) throw signupError;
                    alert('‚úÖ Compte cr√©√© ! V√©rifiez votre email.');
                    setPage('login');
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email, password
                    });

                    if (error) throw error;
                    setUser(data.user);
                    await loadProfile(data.user.id);
                    setPage('dashboard');
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
                setUser(null);
                setProfile(null);
                setPage('home');
            };

            const handleUpdateProfile = async () => {
                setLoading(true);
                try {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .update({
                            bio: editData.bio,
                            secteur: editData.secteur,
                            telephone: editData.telephone,
                            localisation: editData.localisation,
                            reseau_entreprises: editData.reseau_entreprises?.split(',').map(e => e.trim()).filter(Boolean),
                            reseau_competences: editData.reseau_competences?.split(',').map(c => c.trim()).filter(Boolean)
                        })
                        .eq('id', user.id);

                    if (error) throw error;
                    
                    await loadProfile(user.id);
                    setEditMode(false);
                    alert('‚úÖ Profil mis √† jour !');
                } catch (err) {
                    setError('Erreur mise √† jour profil');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handlePosterBesoin = async () => {
                if (!besoinText.trim()) {
                    alert('Veuillez d√©crire votre besoin');
                    return;
                }
                if (!entrepriseVisee.trim()) {
                    alert('Veuillez indiquer l\'entreprise vis√©e');
                    return;
                }
                if (!departement) {
                    alert('Veuillez s√©lectionner un d√©partement');
                    return;
                }
                if (!typeBesoin) {
                    alert('Veuillez s√©lectionner un type de besoin');
                    return;
                }
                
                setLoading(true);

                try {
                    const { error } = await supabaseClient
                        .from('besoins')
                        .insert({
                            user_id: user.id,
                            texte: besoinText,
                            entreprise_visee: entrepriseVisee,
                            departement: departement,
                            type_besoin: typeBesoin,
                            secteur: profile?.secteur || '',
                            statut: 'actif'
                        });

                    if (error) throw error;
                    alert('‚úÖ Besoin publi√© ! Expire dans 15 jours.');
                    setBesoinText('');
                    setEntrepriseVisee('');
                    setDepartement('');
                    setTypeBesoin('');
                    setPage('dashboard');
                } catch (err) {
                    setError('Erreur publication');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handleCloturerBesoin = async (besoinId) => {
                if (!confirm('√ätes-vous s√ªr de vouloir cl√¥turer ce besoin ?')) return;
                
                setLoading(true);
                try {
                    const { error } = await supabaseClient
                        .from('besoins')
                        .update({ statut: 'cloture' })
                        .eq('id', besoinId);
                    
                    if (error) throw error;
                    alert('‚úÖ Besoin cl√¥tur√© !');
                    await loadMesBesoins();
                } catch (err) {
                    console.error('Erreur cl√¥ture:', err);
                    alert('Erreur lors de la cl√¥ture');
                } finally {
                    setLoading(false);
                }
            };

            const handleProlongerBesoin = async (besoinId, dateExpiration) => {
                setLoading(true);
                try {
                    const nouvelleDate = new Date(dateExpiration);
                    nouvelleDate.setDate(nouvelleDate.getDate() + 15);
                    
                    const { error } = await supabaseClient
                        .from('besoins')
                        .update({ date_expiration: nouvelleDate.toISOString() })
                        .eq('id', besoinId);
                    
                    if (error) throw error;
                    alert('‚úÖ Besoin prolong√© de 15 jours !');
                    await loadMesBesoins();
                } catch (err) {
                    console.error('Erreur prolongation:', err);
                    alert('Erreur lors de la prolongation');
                } finally {
                    setLoading(false);
                }
            };

            const handleOpenPropositionModal = (besoin) => {
                setPropositionBesoin(besoin);
                setNiveauContact('');
                setPosteContact('');
                setMessageProposition('');
                setShowPropositionModal(true);
            };

            const handleConfirmerProposition = async () => {
                if (!niveauContact) {
                    alert('Veuillez indiquer votre niveau de contact');
                    return;
                }
                if (!posteContact.trim()) {
                    alert('Veuillez indiquer le poste de votre contact');
                    return;
                }

                setLoading(true);
                try {
                    const { error } = await supabaseClient
                        .from('propositions')
                        .insert({
                            besoin_id: propositionBesoin.id,
                            aidant_id: user.id,
                            statut: 'en_attente',
                            niveau_contact: niveauContact,
                            poste_contact: posteContact,
                            message: messageProposition
                        });

                    if (error) throw error;
                    
                    setShowPropositionModal(false);
                    alert('‚úÖ Proposition envoy√©e !');
                    
                    if (besoinIdx < besoins.length - 1) {
                        setBesoinIdx(besoinIdx + 1);
                    } else {
                        setPage('dashboard');
                        setBesoinIdx(0);
                    }
                } catch (err) {
                    console.error(err);
                    alert('Erreur lors de l\'envoi');
                } finally {
                    setLoading(false);
                }
            };

            const handleAccepterProposition = async (proposition, besoinId) => {
                setLoading(true);
                try {
                    const { data: matchData, error: matchError } = await supabaseClient
                        .from('matchs')
                        .insert({
                            besoin_id: besoinId,
                            demandeur_id: user.id,
                            aidant_id: proposition.aidant_id,
                            statut: 'en_cours'
                        })
                        .select()
                        .single();

                    if (matchError) throw matchError;

                    await supabaseClient
                        .from('propositions')
                        .update({ statut: 'acceptee' })
                        .eq('id', proposition.id);

                    alert('‚úÖ Match cr√©√© ! Vous pouvez maintenant discuter.');
                    setShowPropsModal(false);
                    setSelectedMatch(matchData);
                    setSelectedMatchProposition(proposition);
                    setPage('chat');
                } catch (err) {
                    console.error('Erreur match:', err);
                    alert('Erreur lors de la cr√©ation du match');
                } finally {
                    setLoading(false);
                }
            };

            const handleOpenChat = async (match) => {
                setSelectedMatch(match);
                
                // Charger la proposition correspondante pour avoir le contexte
                try {
                    const { data: propData } = await supabaseClient
                        .from('propositions')
                        .select('*')
                        .eq('besoin_id', match.besoin_id)
                        .eq('aidant_id', match.aidant_id)
                        .eq('statut', 'acceptee')
                        .single();
                    
                    setSelectedMatchProposition(propData);
                } catch (err) {
                    console.error('Erreur chargement proposition:', err);
                }
                
                setPage('chat');
            };

            const handleSendMessage = async () => {
                if (!newMessage.trim() || !selectedMatch) return;

                try {
                    const { error } = await supabaseClient
                        .from('messages')
                        .insert({
                            match_id: selectedMatch.id,
                            sender_id: user.id,
                            texte: newMessage
                        });

                    if (error) throw error;
                    
                    setNewMessage('');
                    await loadMessages();
                } catch (err) {
                    console.error('Erreur envoi message:', err);
                }
            };

            if (loading && !user) {
                return <div style={{minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center'}}><div className="spinner"></div></div>;
            }

            // HOME
            if (page === 'home') {
                return (
                    <div style={{minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px'}} className="fade-in">
                        <div style={{...card, maxWidth: '500px', textAlign: 'center'}}>
                            <h1 style={{fontSize: isMobile ? '36px' : '48px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', fontWeight: '800', marginBottom: '16px'}}>FONDAMENTO</h1>
                            <p style={{color: '#666', marginBottom: '40px'}}>Le r√©seau professionnel qui va √† l'essentiel</p>
                            <button onClick={() => setPage('signup')} style={{...btn(), marginBottom: '16px'}}>‚ú® Cr√©er mon compte</button>
                            <button onClick={() => setPage('login')} style={btn('outline')}>Se connecter</button>
                            <div style={{marginTop: '40px', padding: '20px', background: '#f8f9ff', borderRadius: '15px', fontSize: '14px'}}>
                                üéØ Matching qualifi√©<br/>üí¨ Chat enrichi<br/>üîî Notifications temps r√©el
                            </div>
                        </div>
                    </div>
                );
            }

            // SIGNUP
            if (page === 'signup') {
                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '500px', margin: '0 auto'}}>
                            <button onClick={() => setPage('home')} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                            <div style={card}>
                                <h2 style={{fontSize: '28px', marginBottom: '24px', textAlign: 'center'}}>Cr√©er mon compte</h2>
                                {error && <div style={{padding: '12px', background: '#fee', borderRadius: '8px', color: '#c00', marginBottom: '20px', fontSize: '14px'}}>{error}</div>}
                                <form onSubmit={handleSignup}>
                                    <input type="text" placeholder="Pr√©nom *" value={prenom} onChange={(e) => setPrenom(e.target.value)} style={input} required />
                                    <input type="text" placeholder="Nom *" value={nom} onChange={(e) => setNom(e.target.value)} style={input} required />
                                    <input type="email" placeholder="Email *" value={email} onChange={(e) => setEmail(e.target.value)} style={input} required />
                                    <input type="password" placeholder="Mot de passe (min. 6) *" value={password} onChange={(e) => setPassword(e.target.value)} style={input} minLength="6" required />
                                    <button type="submit" style={btn()} disabled={loading}>{loading ? 'Cr√©ation...' : 'Cr√©er mon compte'}</button>
                                </form>
                                <p style={{marginTop: '20px', textAlign: 'center', color: '#666', fontSize: '14px'}}>
                                    D√©j√† un compte ? <span onClick={() => setPage('login')} style={{color: '#667eea', cursor: 'pointer', fontWeight: '600'}}>Se connecter</span>
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            // LOGIN
            if (page === 'login') {
                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '500px', margin: '0 auto'}}>
                            <button onClick={() => setPage('home')} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                            <div style={card}>
                                <h2 style={{fontSize: '28px', marginBottom: '24px', textAlign: 'center'}}>Connexion</h2>
                                {error && <div style={{padding: '12px', background: '#fee', borderRadius: '8px', color: '#c00', marginBottom: '20px', fontSize: '14px'}}>{error}</div>}
                                <form onSubmit={handleLogin}>
                                    <input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} style={input} required />
                                    <input type="password" placeholder="Mot de passe" value={password} onChange={(e) => setPassword(e.target.value)} style={input} required />
                                    <button type="submit" style={btn()} disabled={loading}>{loading ? 'Connexion...' : 'Se connecter'}</button>
                                </form>
                                <p style={{marginTop: '20px', textAlign: 'center', color: '#666', fontSize: '14px'}}>
                                    Pas de compte ? <span onClick={() => setPage('signup')} style={{color: '#667eea', cursor: 'pointer', fontWeight: '600'}}>S'inscrire</span>
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!user || !profile) return null;

            // DASHBOARD AVEC BADGES
            if (page === 'dashboard') {
                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '1200px', margin: '0 auto'}}>
                            <div style={{...card, marginBottom: '20px'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px'}}>
                                    <h1 style={{fontSize: '28px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', fontWeight: '800'}}>FONDAMENTO</h1>
                                    <div style={{display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                                        <button onClick={() => setPage('profil')} style={{padding: '10px 20px', background: 'white', color: '#667eea', border: '2px solid #667eea', borderRadius: '12px', fontWeight: '600'}}>üë§ Profil</button>
                                        
                                        <div className="notification-badge">
                                            <button onClick={() => { loadMatchs(); setPage('matchs'); }} style={{padding: '10px 20px', background: 'white', color: '#667eea', border: '2px solid #667eea', borderRadius: '12px', fontWeight: '600'}}>
                                                üí¨ Chats
                                            </button>
                                            {nbMessagesNonLus > 0 && <span className="badge">{nbMessagesNonLus}</span>}
                                        </div>
                                        
                                        <button onClick={handleLogout} style={{padding: '10px 20px', background: 'white', color: '#667eea', border: '2px solid #667eea', borderRadius: '12px', fontWeight: '600'}}>D√©connexion</button>
                                    </div>
                                </div>
                                <h2 style={{fontSize: '24px', marginBottom: '12px'}}>Bonjour {profile.prenom} ! üëã</h2>
                                <div style={{marginBottom: '24px'}}>
                                    <span style={{background: '#fef3c7', padding: '6px 14px', borderRadius: '20px', fontSize: '14px', fontWeight: '700', color: '#92400e'}}>‚≠ê {profile.note_globale || 0}/5 ({profile.nb_avis || 0} avis)</span>
                                </div>
                                <div style={{display: 'grid', gap: '15px', gridTemplateColumns: isMobile ? '1fr' : 'repeat(3, 1fr)'}}>
                                    <button onClick={() => setPage('poster')} style={btn()}>üéØ Poster un besoin</button>
                                    <button onClick={() => { loadBesoins(); setPage('voir'); }} style={btn('success')}>üí™ Aider quelqu'un</button>
                                    
                                    <div className="notification-badge" style={{position: 'relative'}}>
                                        <button onClick={() => { loadMesBesoins(); setPage('mes-besoins'); }} style={{...btn(), background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'}}>
                                            üìã Mes besoins
                                        </button>
                                        {nbNouvellesPropositions > 0 && <span className="badge" style={{right: '8px'}}>{nbNouvellesPropositions}</span>}
                                    </div>
                                </div>
                            </div>
                            
                            <div style={card}>
                                <h3 style={{fontSize: '20px', marginBottom: '20px', fontWeight: '700'}}>üìä Mon activit√©</h3>
                                <div style={{display: 'grid', gap: '15px', gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)'}}>
                                    <div style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', padding: '24px', borderRadius: '16px', color: 'white'}}>
                                        <div style={{fontSize: '14px', marginBottom: '8px'}}>Comme aidant</div>
                                        <div style={{fontSize: '36px', fontWeight: '800', marginBottom: '8px'}}>{profile.intros_reussies || 0}</div>
                                        <div style={{fontSize: '14px'}}>intros r√©ussies</div>
                                    </div>
                                    <div style={{background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', padding: '24px', borderRadius: '16px', color: 'white'}}>
                                        <div style={{fontSize: '14px', marginBottom: '8px'}}>Comme demandeur</div>
                                        <div style={{fontSize: '36px', fontWeight: '800', marginBottom: '8px'}}>{profile.echanges_reussis || 0}</div>
                                        <div style={{fontSize: '14px'}}>√©changes r√©ussis</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // PROFIL (identique v4)
            if (page === 'profil') {
                if (editMode && Object.keys(editData).length === 0) {
                    setEditData({
                        bio: profile.bio || '',
                        secteur: profile.secteur || '',
                        telephone: profile.telephone || '',
                        localisation: profile.localisation || '',
                        reseau_entreprises: profile.reseau_entreprises?.join(', ') || '',
                        reseau_competences: profile.reseau_competences?.join(', ') || ''
                    });
                }

                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '800px', margin: '0 auto'}}>
                            <button onClick={() => setPage('dashboard')} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                            
                            <div style={card}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', flexWrap: 'wrap', gap: '10px'}}>
                                    <h2 style={{fontSize: '24px', fontWeight: '700'}}>Mon Profil</h2>
                                    {!editMode ? (
                                        <button onClick={() => setEditMode(true)} style={{padding: '10px 20px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', border: 'none', borderRadius: '12px'}}>‚úèÔ∏è Modifier</button>
                                    ) : (
                                        <div style={{display: 'flex', gap: '10px'}}>
                                            <button onClick={() => { setEditMode(false); setEditData({}); }} style={{padding: '10px 20px', background: 'white', color: '#667eea', border: '2px solid #667eea', borderRadius: '12px'}}>Annuler</button>
                                            <button onClick={handleUpdateProfile} style={{padding: '10px 20px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: 'white', border: 'none', borderRadius: '12px'}}>‚úì Enregistrer</button>
                                        </div>
                                    )}
                                </div>

                                <div style={{textAlign: 'center', marginBottom: '28px'}}>
                                    <div style={{width: '80px', height: '80px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '40px', margin: '0 auto 16px'}}>üë§</div>
                                    <h3 style={{fontSize: '22px', marginBottom: '8px'}}>{profile.prenom} {profile.nom}</h3>
                                    <div style={{fontSize: '14px', color: '#666'}}>{profile.email}</div>
                                </div>

                                {editMode ? (
                                    <div>
                                        <div style={{marginBottom: '16px'}}>
                                            <label style={{display: 'block', marginBottom: '8px', fontWeight: '600'}}>T√©l√©phone</label>
                                            <input type="text" value={editData.telephone || ''} onChange={(e) => setEditData({...editData, telephone: e.target.value})} style={input} />
                                        </div>
                                        <div style={{marginBottom: '16px'}}>
                                            <label style={{display: 'block', marginBottom: '8px', fontWeight: '600'}}>Localisation</label>
                                            <input type="text" value={editData.localisation || ''} onChange={(e) => setEditData({...editData, localisation: e.target.value})} style={input} placeholder="Ex: Paris, France" />
                                        </div>
                                        <div style={{marginBottom: '16px'}}>
                                            <label style={{display: 'block', marginBottom: '8px', fontWeight: '600'}}>Secteur</label>
                                            <input type="text" value={editData.secteur || ''} onChange={(e) => setEditData({...editData, secteur: e.target.value})} style={input} placeholder="Ex: Tech, Finance..." />
                                        </div>
                                        <div style={{marginBottom: '16px'}}>
                                            <label style={{display: 'block', marginBottom: '8px', fontWeight: '600'}}>Bio</label>
                                            <textarea rows="3" value={editData.bio || ''} onChange={(e) => setEditData({...editData, bio: e.target.value})} style={{...input, minHeight: '100px'}} placeholder="Pr√©sentez-vous..." />
                                        </div>
                                        <div style={{marginBottom: '16px'}}>
                                            <label style={{display: 'block', marginBottom: '8px', fontWeight: '600'}}>Entreprises (s√©par√©es par virgules)</label>
                                            <input type="text" value={editData.reseau_entreprises || ''} onChange={(e) => setEditData({...editData, reseau_entreprises: e.target.value})} style={input} placeholder="Ex: Google, Microsoft" />
                                        </div>
                                        <div style={{marginBottom: '16px'}}>
                                            <label style={{display: 'block', marginBottom: '8px', fontWeight: '600'}}>Comp√©tences (s√©par√©es par virgules)</label>
                                            <input type="text" value={editData.reseau_competences || ''} onChange={(e) => setEditData({...editData, reseau_competences: e.target.value})} style={input} placeholder="Ex: Marketing, Finance" />
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <div style={{marginBottom: '20px'}}><strong>T√©l√©phone :</strong> {profile.telephone || 'Non renseign√©'}</div>
                                        <div style={{marginBottom: '20px'}}><strong>Localisation :</strong> {profile.localisation || 'Non renseign√©e'}</div>
                                        <div style={{marginBottom: '20px'}}><strong>Secteur :</strong> {profile.secteur || 'Non renseign√©'}</div>
                                        <div style={{marginBottom: '20px'}}><strong>Bio :</strong> {profile.bio || 'Aucune bio'}</div>
                                        <div style={{marginBottom: '20px'}}>
                                            <strong>Entreprises :</strong>
                                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px', marginTop: '8px'}}>
                                                {profile.reseau_entreprises?.length > 0 ? profile.reseau_entreprises.map(e => (
                                                    <span key={e} style={{background: '#f3f4f6', padding: '6px 12px', borderRadius: '10px', fontSize: '14px'}}>{e}</span>
                                                )) : 'Aucune'}
                                            </div>
                                        </div>
                                        <div>
                                            <strong>Comp√©tences :</strong>
                                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px', marginTop: '8px'}}>
                                                {profile.reseau_competences?.length > 0 ? profile.reseau_competences.map(c => (
                                                    <span key={c} style={{background: '#e0e7ff', padding: '6px 12px', borderRadius: '10px', fontSize: '14px'}}>{c}</span>
                                                )) : 'Aucune'}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // MES BESOINS AVEC EXPIRATION ET CL√îTURE
            if (page === 'mes-besoins') {
                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '900px', margin: '0 auto'}}>
                            <button onClick={() => setPage('dashboard')} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                            
                            <div style={card}>
                                <h2 style={{fontSize: '24px', marginBottom: '24px', fontWeight: '700'}}>üìã Mes besoins post√©s</h2>
                                
                                {mesBesoins.length === 0 ? (
                                    <div style={{textAlign: 'center', padding: '40px', color: '#666'}}>
                                        <div style={{fontSize: '48px', marginBottom: '16px'}}>üéØ</div>
                                        <p>Vous n'avez pas encore post√© de besoin</p>
                                        <button onClick={() => setPage('poster')} style={{...btn(), marginTop: '20px', width: '300px'}}>Poster mon premier besoin</button>
                                    </div>
                                ) : (
                                    mesBesoins.map(besoin => {
                                        const badge = getBadgeStatut(besoin.date_expiration, besoin.statut);
                                        const jours = getJoursRestants(besoin.date_expiration);
                                        const peutProlonger = besoin.statut === 'actif' && jours !== null && jours <= 5 && jours >= 0;
                                        
                                        return (
                                            <div key={besoin.id} style={{background: '#f8f9ff', padding: '20px', borderRadius: '12px', marginBottom: '16px', border: '1px solid #e0e7ff'}}>
                                                <div style={{marginBottom: '12px'}}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px', flexWrap: 'wrap', gap: '8px'}}>
                                                        <div style={{fontSize: '16px', fontWeight: '600', flex: 1}}>{besoin.texte}</div>
                                                        <span style={{background: badge.color, color: 'white', padding: '4px 12px', borderRadius: '12px', fontSize: '12px', fontWeight: '600', whiteSpace: 'nowrap'}}>
                                                            {badge.emoji} {badge.text}
                                                        </span>
                                                    </div>
                                                    <div style={{display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '8px'}}>
                                                        <span style={{background: '#e0e7ff', padding: '4px 10px', borderRadius: '8px', fontSize: '13px', color: '#667eea', fontWeight: '600'}}>
                                                            üè¢ {besoin.entreprise_visee}
                                                        </span>
                                                        <span style={{background: '#fce7f3', padding: '4px 10px', borderRadius: '8px', fontSize: '13px', color: '#9f1239', fontWeight: '600'}}>
                                                            üìä {besoin.departement}
                                                        </span>
                                                        <span style={{background: '#d1fae5', padding: '4px 10px', borderRadius: '8px', fontSize: '13px', color: '#065f46', fontWeight: '600'}}>
                                                            üéØ {besoin.type_besoin}
                                                        </span>
                                                    </div>
                                                    <div style={{fontSize: '13px', color: '#666'}}>Post√© le {new Date(besoin.created_at).toLocaleDateString('fr-FR')}</div>
                                                </div>
                                                
                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '10px'}}>
                                                    <span style={{background: '#10b981', color: 'white', padding: '6px 14px', borderRadius: '20px', fontSize: '14px', fontWeight: '600'}}>
                                                        {propositionsParBesoin[besoin.id]?.filter(p => p.statut === 'en_attente').length || 0} nouvelle(s) proposition(s)
                                                    </span>
                                                    
                                                    <div style={{display: 'flex', gap: '8px', flexWrap: 'wrap'}}>
                                                        {(propositionsParBesoin[besoin.id]?.length || 0) > 0 && (
                                                            <button onClick={() => { setSelectedBesoinProps(besoin.id); setShowPropsModal(true); }} style={{padding: '8px 16px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', border: 'none', borderRadius: '10px', fontSize: '14px', fontWeight: '600'}}>
                                                                üëÅÔ∏è Voir propositions
                                                            </button>
                                                        )}
                                                        
                                                        {peutProlonger && (
                                                            <button onClick={() => handleProlongerBesoin(besoin.id, besoin.date_expiration)} style={{padding: '8px 16px', background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', color: 'white', border: 'none', borderRadius: '10px', fontSize: '14px', fontWeight: '600'}}>
                                                                ‚è∞ Prolonger
                                                            </button>
                                                        )}
                                                        
                                                        {besoin.statut === 'actif' && (
                                                            <button onClick={() => handleCloturerBesoin(besoin.id)} style={{padding: '8px 16px', background: 'white', color: '#6b7280', border: '2px solid #d1d5db', borderRadius: '10px', fontSize: '14px', fontWeight: '600'}}>
                                                                ‚úì Cl√¥turer
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>

                        {/* MODAL PROPOSITIONS (identique v4) */}
                        {showPropsModal && selectedBesoinProps && (
                            <div className="modal-backdrop" onClick={() => setShowPropsModal(false)}>
                                <div style={{...card, maxWidth: '800px', maxHeight: '85vh', overflow: 'auto'}} onClick={(e) => e.stopPropagation()}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px'}}>
                                        <h3 style={{fontSize: '20px', fontWeight: '700'}}>Propositions re√ßues</h3>
                                        <button onClick={() => setShowPropsModal(false)} style={{background: '#f3f4f6', border: 'none', width: '36px', height: '36px', borderRadius: '50%', fontSize: '18px'}}>‚úï</button>
                                    </div>
                                    {propositionsParBesoin[selectedBesoinProps]?.map(prop => {
                                        const niveauLabel = getNiveauContactLabel(prop.niveau_contact);
                                        return (
                                            <div key={prop.id} style={{background: '#f8f9ff', padding: '20px', borderRadius: '12px', marginBottom: '16px', border: '1px solid #e0e7ff'}}>
                                                <div style={{marginBottom: '16px'}}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px', flexWrap: 'wrap', gap: '10px'}}>
                                                        <div>
                                                            <div style={{fontSize: '18px', fontWeight: '600', marginBottom: '4px'}}>
                                                                {prop.profiles?.prenom} {prop.profiles?.nom?.[0]}.
                                                            </div>
                                                            <div style={{fontSize: '14px', color: '#666'}}>
                                                                {prop.profiles?.secteur} ‚Ä¢ ‚≠ê {prop.profiles?.note_globale || 0}/5
                                                            </div>
                                                        </div>
                                                        <span style={{
                                                            background: prop.niveau_contact === 'direct' ? '#d1fae5' : 
                                                                       prop.niveau_contact === 'niveau_2' ? '#fef3c7' : '#fed7aa',
                                                            color: prop.niveau_contact === 'direct' ? '#065f46' :
                                                                   prop.niveau_contact === 'niveau_2' ? '#92400e' : '#9a3412',
                                                            padding: '6px 14px',
                                                            borderRadius: '20px',
                                                            fontSize: '13px',
                                                            fontWeight: '600'
                                                        }}>
                                                            {niveauLabel.emoji} {niveauLabel.text}
                                                        </span>
                                                    </div>
                                                    
                                                    <div style={{background: 'white', padding: '12px', borderRadius: '10px', marginBottom: '12px'}}>
                                                        <div style={{fontSize: '13px', color: '#666', marginBottom: '4px'}}>Poste du contact :</div>
                                                        <div style={{fontSize: '15px', fontWeight: '600'}}>{prop.poste_contact}</div>
                                                    </div>
                                                    
                                                    {prop.message && (
                                                        <div style={{background: 'white', padding: '12px', borderRadius: '10px', marginBottom: '12px'}}>
                                                            <div style={{fontSize: '13px', color: '#666', marginBottom: '4px'}}>Message :</div>
                                                            <div style={{fontSize: '14px', lineHeight: '1.6', fontStyle: 'italic'}}>"{prop.message}"</div>
                                                        </div>
                                                    )}
                                                </div>
                                                <button onClick={() => handleAccepterProposition(prop, selectedBesoinProps)} style={{...btn(), width: 'auto', padding: '12px 24px', fontSize: '15px'}}>
                                                    üí¨ Accepter et discuter
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // POSTER (identique v4)
            if (page === 'poster') {
                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '800px', margin: '0 auto'}}>
                            <button onClick={() => setPage('dashboard')} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                            
                            <div style={card}>
                                <h2 style={{fontSize: '28px', marginBottom: '16px', fontWeight: '700'}}>üéØ Poster un besoin</h2>
                                <p style={{color: '#666', marginBottom: '24px'}}>D√©crivez pr√©cis√©ment votre besoin. Il sera actif pendant 15 jours.</p>
                                {error && <div style={{padding: '12px', background: '#fee', borderRadius: '8px', color: '#c00', marginBottom: '20px', fontSize: '14px'}}>{error}</div>}
                                
                                <div style={{marginBottom: '16px'}}>
                                    <label style={{display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '15px'}}>Description de votre besoin *</label>
                                    <textarea value={besoinText} onChange={(e) => setBesoinText(e.target.value)} placeholder="Ex: Je cherche un contact au sein du d√©partement marketing..." rows="4" style={{...input, minHeight: '100px'}} />
                                </div>

                                <div style={{marginBottom: '16px'}}>
                                    <label style={{display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '15px'}}>Entreprise vis√©e *</label>
                                    <input type="text" value={entrepriseVisee} onChange={(e) => setEntrepriseVisee(e.target.value)} placeholder="Ex: Nestl√©, Google, LVMH..." style={input} />
                                </div>

                                <div style={{marginBottom: '16px'}}>
                                    <label style={{display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '15px'}}>D√©partement / Service *</label>
                                    <select value={departement} onChange={(e) => setDepartement(e.target.value)} style={input}>
                                        <option value="">-- S√©lectionnez --</option>
                                        {DEPARTEMENTS.map(dep => (
                                            <option key={dep} value={dep}>{dep}</option>
                                        ))}
                                    </select>
                                </div>

                                <div style={{marginBottom: '24px'}}>
                                    <label style={{display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '15px'}}>Type de besoin *</label>
                                    <select value={typeBesoin} onChange={(e) => setTypeBesoin(e.target.value)} style={input}>
                                        <option value="">-- S√©lectionnez --</option>
                                        {TYPES_BESOIN.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>

                                <button onClick={handlePosterBesoin} disabled={loading || !besoinText.trim() || !entrepriseVisee.trim() || !departement || !typeBesoin} style={{...btn(), opacity: (besoinText.trim() && entrepriseVisee.trim() && departement && typeBesoin && !loading) ? 1 : 0.5}}>
                                    {loading ? 'Publication...' : 'Publier (actif 15 jours)'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // VOIR BESOINS (identique v4 mais filtre expiration)
            if (page === 'voir') {
                if (besoins.length === 0) {
                    return (
                        <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                            <div style={{maxWidth: '600px', margin: '0 auto'}}>
                                <button onClick={() => setPage('dashboard')} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                                <div style={{...card, textAlign: 'center'}}>
                                    <div style={{fontSize: '64px', marginBottom: '20px'}}>üéØ</div>
                                    <h2 style={{fontSize: '24px', marginBottom: '16px'}}>Aucun besoin disponible</h2>
                                </div>
                            </div>
                        </div>
                    );
                }

                const besoin = besoins[besoinIdx];
                const badge = getBadgeStatut(besoin.date_expiration, besoin.statut);
                
                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '600px', margin: '0 auto'}}>
                            <button onClick={() => setPage('dashboard')} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                            
                            <div style={{...card, minHeight: '550px', display: 'flex', flexDirection: 'column', justifyContent: 'space-between'}}>
                                <div>
                                    <div style={{textAlign: 'center', marginBottom: '20px'}}>
                                        <span style={{background: badge.color, color: 'white', padding: '6px 14px', borderRadius: '20px', fontSize: '13px', fontWeight: '600'}}>
                                            {badge.emoji} {badge.text}
                                        </span>
                                    </div>
                                    
                                    <div style={{textAlign: 'center', marginBottom: '24px'}}>
                                        <div style={{fontSize: '64px', marginBottom: '16px'}}>üë§</div>
                                        <h3 style={{fontSize: '22px', marginBottom: '12px', fontWeight: '700'}}>
                                            {besoin.profiles?.prenom} {besoin.profiles?.nom?.[0]}.
                                        </h3>
                                        <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', flexWrap: 'wrap', marginBottom: '12px'}}>
                                            <span style={{background: '#fef3c7', padding: '6px 12px', borderRadius: '20px', fontSize: '13px', fontWeight: '700', color: '#92400e'}}>‚≠ê {besoin.profiles?.note_globale || 0}/5</span>
                                            <span style={{background: '#e0e7ff', padding: '6px 12px', borderRadius: '20px', fontSize: '13px', fontWeight: '700', color: '#3730a3'}}>{besoin.profiles?.secteur}</span>
                                        </div>
                                    </div>

                                    <div style={{background: 'linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%)', padding: '20px', borderRadius: '14px', marginBottom: '16px', border: '1px solid rgba(102, 126, 234, 0.2)'}}>
                                        <h4 style={{color: '#667eea', marginBottom: '10px', fontWeight: '700', fontSize: '14px'}}>Son besoin :</h4>
                                        <p style={{fontSize: '15px', lineHeight: '1.7', marginBottom: '12px'}}>{besoin.texte}</p>
                                        <div style={{display: 'flex', gap: '6px', flexWrap: 'wrap'}}>
                                            <span style={{background: 'white', padding: '6px 12px', borderRadius: '10px', fontSize: '12px', color: '#667eea', fontWeight: '600'}}>
                                                üè¢ {besoin.entreprise_visee}
                                            </span>
                                            <span style={{background: 'white', padding: '6px 12px', borderRadius: '10px', fontSize: '12px', color: '#9f1239', fontWeight: '600'}}>
                                                üìä {besoin.departement}
                                            </span>
                                            <span style={{background: 'white', padding: '6px 12px', borderRadius: '10px', fontSize: '12px', color: '#065f46', fontWeight: '600'}}>
                                                üéØ {besoin.type_besoin}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div style={{display: 'flex', gap: '20px', justifyContent: 'center', marginBottom: '20px'}}>
                                        <button onClick={() => besoinIdx < besoins.length - 1 ? setBesoinIdx(besoinIdx + 1) : setPage('dashboard')} style={{width: '80px', height: '80px', background: 'white', border: '4px solid #ef4444', borderRadius: '50%', fontSize: '32px'}}>‚úó</button>
                                        <button onClick={() => handleOpenPropositionModal(besoin)} style={{width: '80px', height: '80px', background: 'white', border: '4px solid #10b981', borderRadius: '50%', fontSize: '32px'}}>‚úì</button>
                                    </div>
                                    <p style={{textAlign: 'center', color: '#666', fontSize: '14px', fontWeight: '600'}}>{besoinIdx + 1} / {besoins.length}</p>
                                </div>
                            </div>
                        </div>

                        {/* MODAL QUALIFICATION (identique v4) */}
                        {showPropositionModal && propositionBesoin && (
                            <div className="modal-backdrop">
                                <div style={{...card, maxWidth: '600px', maxHeight: '90vh', overflow: 'auto'}} onClick={(e) => e.stopPropagation()}>
                                    <h3 style={{fontSize: '22px', marginBottom: '8px', fontWeight: '700'}}>Qualifiez votre proposition</h3>
                                    <p style={{color: '#666', marginBottom: '24px', fontSize: '14px'}}>
                                        Ces informations seront visibles par le demandeur.
                                    </p>

                                    <div style={{marginBottom: '20px'}}>
                                        <label style={{display: 'block', marginBottom: '12px', fontWeight: '600', fontSize: '15px'}}>
                                            Quel est votre niveau de contact ? *
                                        </label>
                                        <div className={`radio-option ${niveauContact === 'direct' ? 'selected' : ''}`} onClick={() => setNiveauContact('direct')}>
                                            <input type="radio" checked={niveauContact === 'direct'} onChange={() => {}} />
                                            <div>
                                                <div style={{fontWeight: '600', marginBottom: '4px'}}>üü¢ Contact direct</div>
                                                <div style={{fontSize: '13px', color: '#666'}}>Je connais personnellement la personne</div>
                                            </div>
                                        </div>
                                        <div className={`radio-option ${niveauContact === 'niveau_2' ? 'selected' : ''}`} onClick={() => setNiveauContact('niveau_2')}>
                                            <input type="radio" checked={niveauContact === 'niveau_2'} onChange={() => {}} />
                                            <div>
                                                <div style={{fontWeight: '600', marginBottom: '4px'}}>üü° Contact 2√®me niveau</div>
                                                <div style={{fontSize: '13px', color: '#666'}}>Ami d'un ami, coll√®gue indirect</div>
                                            </div>
                                        </div>
                                        <div className={`radio-option ${niveauContact === 'niveau_3' ? 'selected' : ''}`} onClick={() => setNiveauContact('niveau_3')}>
                                            <input type="radio" checked={niveauContact === 'niveau_3'} onChange={() => {}} />
                                            <div>
                                                <div style={{fontWeight: '600', marginBottom: '4px'}}>üü† Contact 3√®me niveau</div>
                                                <div style={{fontSize: '13px', color: '#666'}}>R√©seau √©tendu, connaissance √©loign√©e</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{marginBottom: '20px'}}>
                                        <label style={{display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '15px'}}>
                                            Poste / Fonction de votre contact *
                                        </label>
                                        <input 
                                            type="text" 
                                            value={posteContact} 
                                            onChange={(e) => setPosteContact(e.target.value)}
                                            placeholder="Ex: Directeur Marketing Europe..."
                                            style={input}
                                        />
                                    </div>

                                    <div style={{marginBottom: '24px'}}>
                                        <label style={{display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '15px'}}>
                                            Message pour le demandeur (optionnel)
                                        </label>
                                        <textarea 
                                            value={messageProposition} 
                                            onChange={(e) => setMessageProposition(e.target.value)}
                                            placeholder="Ex: Je connais bien le Directeur Marketing..."
                                            rows="3"
                                            style={{...input, minHeight: '80px'}}
                                        />
                                    </div>

                                    <div style={{display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 2fr', gap: '12px'}}>
                                        <button onClick={() => setShowPropositionModal(false)} style={{...btn('outline'), padding: '14px'}}>
                                            Annuler
                                        </button>
                                        <button onClick={handleConfirmerProposition} disabled={!niveauContact || !posteContact.trim()} style={{...btn(), padding: '14px', opacity: (niveauContact && posteContact.trim()) ? 1 : 0.5}}>
                                            ‚úì Confirmer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // MATCHS (identique v4)
            if (page === 'matchs') {
                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '900px', margin: '0 auto'}}>
                            <button onClick={() => setPage('dashboard')} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                            
                            <div style={card}>
                                <h2 style={{fontSize: '24px', marginBottom: '24px', fontWeight: '700'}}>üí¨ Mes conversations</h2>
                                
                                {matchs.length === 0 ? (
                                    <div style={{textAlign: 'center', padding: '40px', color: '#666'}}>
                                        <div style={{fontSize: '48px', marginBottom: '16px'}}>üí¨</div>
                                        <p>Aucune conversation active</p>
                                    </div>
                                ) : (
                                    matchs.map(match => {
                                        const isIDemandeur = match.demandeur_id === user.id;
                                        const otherPerson = isIDemandeur ? match.aidant : match.demandeur;
                                        
                                        return (
                                            <div key={match.id} style={{background: '#f8f9ff', padding: '20px', borderRadius: '12px', marginBottom: '16px', border: '1px solid #e0e7ff', cursor: 'pointer'}}
                                                 onClick={() => handleOpenChat(match)}>
                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                    <div>
                                                        <div style={{fontSize: '18px', fontWeight: '600', marginBottom: '4px'}}>
                                                            {otherPerson?.prenom} {otherPerson?.nom}
                                                        </div>
                                                        <div style={{fontSize: '14px', color: '#666', marginBottom: '4px'}}>
                                                            {match.besoin?.texte?.substring(0, 60)}...
                                                        </div>
                                                        <div style={{fontSize: '12px', color: '#999'}}>
                                                            üè¢ {match.besoin?.entreprise_visee}
                                                        </div>
                                                    </div>
                                                    <div style={{fontSize: '24px'}}>üí¨</div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // CHAT ENRICHI
            if (page === 'chat' && selectedMatch) {
                const isIDemandeur = selectedMatch.demandeur_id === user.id;
                const otherPerson = isIDemandeur ? selectedMatch.aidant : selectedMatch.demandeur;
                const niveauLabel = selectedMatchProposition ? getNiveauContactLabel(selectedMatchProposition.niveau_contact) : null;

                return (
                    <div style={{minHeight: '100vh', padding: '20px'}} className="fade-in">
                        <div style={{maxWidth: '800px', margin: '0 auto'}}>
                            <button onClick={() => { setPage('matchs'); setSelectedMatch(null); setSelectedMatchProposition(null); }} style={{padding: '12px 24px', background: 'rgba(255,255,255,0.9)', color: '#667eea', border: 'none', borderRadius: '12px', marginBottom: '20px'}}>‚Üê Retour</button>
                            
                            <div style={card}>
                                {/* HEADER ENRICHI */}
                                <div style={{background: 'linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%)', padding: '20px', borderRadius: '14px', marginBottom: '20px', border: '1px solid rgba(102, 126, 234, 0.2)'}}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '12px'}}>
                                        <div style={{width: '56px', height: '56px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px'}}>üë§</div>
                                        <div style={{flex: 1}}>
                                            <h3 style={{fontSize: '22px', fontWeight: '700', marginBottom: '4px'}}>
                                                {otherPerson?.prenom} {otherPerson?.nom}
                                            </h3>
                                            <div style={{display: 'flex', gap: '8px', flexWrap: 'wrap'}}>
                                                <span style={{background: 'white', padding: '4px 10px', borderRadius: '10px', fontSize: '12px', fontWeight: '600', color: '#92400e'}}>
                                                    ‚≠ê {otherPerson?.note_globale || 0}/5
                                                </span>
                                                <span style={{background: 'white', padding: '4px 10px', borderRadius: '10px', fontSize: '12px', fontWeight: '600', color: '#667eea'}}>
                                                    {otherPerson?.secteur}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {selectedMatchProposition && (
                                        <div style={{background: 'white', padding: '12px', borderRadius: '10px', marginBottom: '12px'}}>
                                            <div style={{fontSize: '12px', color: '#666', marginBottom: '6px'}}>Qualification :</div>
                                            <div style={{display: 'flex', gap: '8px', flexWrap: 'wrap', alignItems: 'center'}}>
                                                <span style={{
                                                    background: selectedMatchProposition.niveau_contact === 'direct' ? '#d1fae5' : 
                                                               selectedMatchProposition.niveau_contact === 'niveau_2' ? '#fef3c7' : '#fed7aa',
                                                    color: selectedMatchProposition.niveau_contact === 'direct' ? '#065f46' :
                                                           selectedMatchProposition.niveau_contact === 'niveau_2' ? '#92400e' : '#9a3412',
                                                    padding: '4px 10px',
                                                    borderRadius: '10px',
                                                    fontSize: '12px',
                                                    fontWeight: '600'
                                                }}>
                                                    {niveauLabel?.emoji} {niveauLabel?.text}
                                                </span>
                                                <span style={{fontSize: '13px', fontWeight: '600', color: '#374151'}}>
                                                    ‚Ä¢ {selectedMatchProposition.poste_contact}
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div style={{background: 'white', padding: '12px', borderRadius: '10px'}}>
                                        <div style={{fontSize: '12px', color: '#666', marginBottom: '4px'}}>Besoin :</div>
                                        <div style={{fontSize: '13px', lineHeight: '1.5'}}>{selectedMatch.besoin?.texte}</div>
                                    </div>
                                </div>

                                <div className="chat-messages">
                                    {messages.length === 0 ? (
                                        <div style={{textAlign: 'center', padding: '40px', color: '#999'}}>
                                            Aucun message. Commencez la conversation ! üí¨
                                        </div>
                                    ) : (
                                        messages.map(msg => (
                                            <div key={msg.id} className={`message ${msg.sender_id === user.id ? 'me' : 'other'}`}>
                                                <div className="message-bubble">
                                                    {msg.texte}
                                                </div>
                                                <div className="message-time">
                                                    {new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                <div style={{display: 'flex', gap: '10px'}}>
                                    <input 
                                        type="text" 
                                        value={newMessage} 
                                        onChange={(e) => setNewMessage(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                        placeholder="Votre message..."
                                        style={{...input, marginBottom: 0, flex: 1}}
                                    />
                                    <button onClick={handleSendMessage} style={{width: 'auto', padding: '14px 24px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', border: 'none', borderRadius: '12px', fontWeight: '600'}}>
                                        Envoyer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return <div>Page inconnue</div>;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
